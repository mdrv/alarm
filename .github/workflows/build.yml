name: Build AArch64 Arch Repo

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Weekly rebuild on Sunday midnight UTC

concurrency:
  group: aarch64-repo
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    defaults:
      run:
        shell: bash
    steps:
    - uses: actions/checkout@v4

    - name: Get runner user UID/GID
      id: user
      run: |
        echo "uid=$(id -u)" >> $GITHUB_OUTPUT
        echo "gid=$(id -g)" >> $GITHUB_OUTPUT

    - name: Build packages in Arch Linux ARM container
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/work \
          -w /work \
          -e HOST_UID="${{ steps.user.outputs.uid }}" \
          -e HOST_GID="${{ steps.user.outputs.gid }}" \
          ghcr.io/menci/archlinuxarm:base-devel \
          bash /work/.github/scripts/build-aarch64.sh

    - name: Generate HTML indexes
      run: |
        # Generate root index.html
        cat > index.html <<'EOFROOT'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Index of /</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
                    background-color: #2e3440;
                    color: #d8dee9;
                    margin: 0;
                    padding: 20px;
                    line-height: 1.6;
                }
                a {
                    color: #88c0d0;
                    text-decoration: none;
                }
                a:hover {
                    color: #bf40bf;
                    text-decoration: underline;
                }
                .directory {
                    color: #8fbcbb;
                    font-weight: 500;
                }
            </style>
        </head>
        <body>
            <h1>Index of /</h1>
            <ul>
                <li><a href="aarch64/" class="directory">aarch64/</a></li>
            </ul>
        </body>
        </html>
        EOFROOT

        # Generate aarch64/index.html
        cat > aarch64/index.html <<'EOFAARCH64'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Index of /aarch64</title>
            <style>
                body {
                    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", sans-serif;
                    background-color: #2e3440;
                    color: #d8dee9;
                    margin: 0;
                    padding: 20px;
                    line-height: 1.6;
                }
                a {
                    color: #88c0d0;
                    text-decoration: none;
                }
                a:hover {
                    color: #bf40bf;
                    text-decoration: underline;
                }
                .directory {
                    color: #8fbcbb;
                    font-weight: 500;
                }
                table {
                    width: 100%;
                    max-width: 800px;
                    border-collapse: collapse;
                    margin-top: 20px;
                }
                th, td {
                    text-align: left;
                    padding: 8px;
                    border-bottom: 1px solid #4c566a;
                }
                tr:last-child td {
                    border-bottom: none;
                }
                .file-name {
                    font-family: 'Courier New', monospace;
                    font-size: 0.95em;
                }
            </style>
        </head>
        <body>
            <h1>Index of /aarch64</h1>
            <p><a href="../" class="directory">../</a></p>
            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Last Modified</th>
                        <th>Size</th>
                    </tr>
                </thead>
                <tbody>
        EOFAARCH64

        # Add file entries using ls and grep to parse
        ls -l --time-style=+%Y-%m-%d %H:%M --quoting-style=shell aarch64/*.pkg.tar.xz aarch64/*.pkg.tar.zst aarch64/*.db.tar.gz aarch64/*.files.tar.gz aarch64/*.db aarch64/*.files 2>/dev/null | while IFS= read -r perms links user group size month day time filename; do
          filename="${filename##*/}"
          size_human=$(numfmt --to=iec --suffix=B "$size" 2>/dev/null || echo "$size bytes")
          mtime="${month} ${day} ${time}"
          
          # Escape filename for HTML
          escaped_filename="${filename//&/&amp;}"
          escaped_filename="${escaped_filename//</<&#60;}"
          escaped_filename="${escaped_filename//>/&#62;}"
          escaped_filename="${escaped_filename//\"/&#34;}"
          
          cat >> aarch64/index.html <<FILEENTRY
                    <tr>
                        <td><a href="$filename" class="file-name">$filename</a></td>
                        <td>$mtime</td>
                        <td>$size_human</td>
                    </tr>
        FILEENTRY
        done

        # Close the table and HTML
        cat >> aarch64/index.html <<'EOFAARCH64END'
                </tbody>
            </table>
        </body>
        </html>
        EOFAARCH64END

        echo "Index files generated successfully"

    - name: Stage files for GitHub Pages
      run: |
        # Clean up any existing public directory
        if [ -d "public" ]; then
          sudo rm -rf public
        fi

        # Create public directory structure
        mkdir -p public/aarch64

        # Copy all files
        cp -r aarch64 public/
        cp index.html public/

        echo "Staging complete, listing public/:"
        ls -la public/ || true
        echo ""
        echo "Listing public/aarch64/:"
        ls -la public/aarch64/ || true

    - name: Upload build artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: aarch64-packages
        path: public/
        retention-days: 7

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: public
        publish_branch: gh-pages
        user_name: 'github-actions[bot]'
        user_email: '41898282+github-actions[bot]@users.noreply.github.com'
