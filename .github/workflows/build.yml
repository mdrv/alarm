name: Build AArch64 Arch Repo

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Build packages in Arch Linux ARM container
      run: |
        docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/output \
          ghcr.io/menci/archlinuxarm:base-devel \
          bash -c "export PACKAGER='mdrv <mdrv@users.noreply.github.com>' && useradd -m builder && cp -r /output/packages /home/builder/ && cd /home/builder/packages && for pkgdir in */; do echo '::group::Building \$pkgdir' && cd \"\$pkgdir\" && makepkg --sign --needed --noconfirm -f || true && cd .. && echo '::endgroup::' && mkdir -p /output/aarch64 && find /home/builder/packages -name '*.pkg.tar.zst' -exec cp {} /output/aarch64/ \\; && find /home/builder/packages -name '*.pkg.tar.zst.sig' -exec cp {} /output/aarch64/ \\; && cd /output/aarch64 && if [ -n \"\$(ls *.pkg.tar.zst 2>/dev/null)\" ]; then repo-add --sign --verify mdrv.db.tar.gz *.pkg.tar.zst; else touch mdrv.db.tar.gz; fi"

    - name: Generate index.html
      run: |
        BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        sed "s/BUILD_DATE/$BUILD_DATE/" index.html.template > aarch64/index.html

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: gh-pages
        exclude_files: |
          .git
          packages
          .github
          index.html.template
        user_name: 'github-actions[bot]'
        user_email: '41898282+github-actions[bot]@users.noreply.github.com'
